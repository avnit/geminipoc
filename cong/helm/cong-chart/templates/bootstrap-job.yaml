{{- if .Values.bootstrap.enabled -}}
---
apiVersion: batch/v1
kind: Job
metadata:
  namespace: {{ .Values.namespace }}
  name: {{ include "cong-chart.fullname" . }}-bootstrap
  annotations:
    "helm.sh/hook": pre-install,pre-upgrade
    "helm.sh/hook-weight": "5"
    "helm.sh/hook-delete-policy": before-hook-creation
  labels:
    {{- include "cong-chart.labels" . | nindent 4 }}
    app.kubernetes.io/component: bootstrap
spec:
  template:
    spec:
      serviceAccountName: {{ include "cong-chart.serviceAccountName" . }}
      initContainers:
        - name: wait-for-consul
          image: busybox:1.28
          command: ['sh', '-c', 'until nc -z {{ include "cong-chart.fullname" . }}-consul 8500; do echo "waiting for consul"; sleep 2; done;']
      containers:
        - name: bootstrap
          image: "{{ .Values.bootstrap.image.repository }}:{{ .Values.bootstrap.image.tag | default .Chart.AppVersion }}"
          imagePullPolicy: {{ .Values.bootstrap.image.pullPolicy }}
          command:
            - "bin/bootstrap"
            - "-Dlog4j.configurationFile=/opt/log4j2.xml"
          env:
            - name: CONSUL_HOST
              value: "{{ include "cong-chart.fullname" . }}-consul"
          volumeMounts:
            - name: log4j-config
              mountPath: /opt/log4j2.xml
              subPath: log4j2.xml
      volumes:
        - name: log4j-config
          configMap:
            name: {{ include "cong-chart.fullname" . }}-log4j-config
      restartPolicy: OnFailure
  backoffLimit: 10
{{- end }}